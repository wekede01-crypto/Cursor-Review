import pandas as pd
import matplotlib.pyplot as plt
import os

# === 1. è¯»å–æ•°æ® ===
print("ğŸ“Š è¯»å–æ•°æ®ä¸­...")
try:
    df = pd.read_csv("review_data.csv") # ç¡®ä¿è¿™ä¸ªæ–‡ä»¶åå’Œä½ åˆšæ‰ç”Ÿæˆçš„ CSV ä¸€è‡´
except FileNotFoundError:
    print("âŒ æ²¡æ‰¾åˆ° CSV æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ spider.py")
    exit()

# === 2. æ•°æ®æ¸…æ´— ===
df['Price_Num'] = pd.to_numeric(df['ä»·æ ¼'].astype(str).str.replace('$', '').str.replace(',', ''), errors='coerce')
df = df.dropna(subset=['Price_Num'])

# === 3. ç”»å›¾ ===
plt.figure(figsize=(10, 6))
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS'] 
plt.rcParams['axes.unicode_minus'] = False

colors = ['skyblue' if 'medicube' in name.lower() else 'lightgray' for name in df['æ ‡é¢˜']]
bars = plt.bar(df['ASIN'], df['Price_Num'], color=colors)

plt.title('Amazon Competitor Price Monitor', fontsize=16) # ç”¨è‹±æ–‡æ ‡é¢˜ï¼Œé˜²æ­¢ç½‘é¡µä¹±ç 
plt.xlabel('ASIN', fontsize=12)
plt.ylabel('Price ($)', fontsize=12)
plt.grid(axis='y', linestyle='--', alpha=0.3)

for bar in bars:
    height = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2., height, f'${height}', ha='center', va='bottom')

plt.tight_layout()

# === â­ æ ¸å¿ƒæ”¹å˜ï¼šä¿å­˜ä¸ºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯å¼¹çª— ===
print("ğŸ–¼ï¸ æ­£åœ¨ä¿å­˜å›¾è¡¨ä¸º chart.png ...")
plt.savefig('chart.png') 

# === â­ æ ¸å¿ƒæ”¹å˜ï¼šç”Ÿæˆ index.html ç½‘é¡µ ===
print("ğŸ“ æ­£åœ¨ç”Ÿæˆ index.html ...")

html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Amazon Price Monitor</title>
    <style>
        body {{ font-family: sans-serif; text-align: center; padding: 50px; }}
        h1 {{ color: #333; }}
        img {{ max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }}
        .timestamp {{ color: #888; margin-top: 20px; }}
    </style>
</head>
<body>
    <h1>Amazon Price Analysis Report</h1>
    <p>Latest Data from Python Bot</p>
    
    <img src="chart.png" alt="Price Chart">
    
    <p class="timestamp">Generated by Cursor Python Bot</p>
</body>
</html>
"""

# å†™å…¥ HTML æ–‡ä»¶
with open("index.html", "w", encoding="utf-8") as f:
    f.write(html_content)

print("ğŸ‰ ç½‘é¡µæŠ¥å‘Šç”Ÿæˆå®Œæ¯•ï¼ä½ å¯ä»¥åŒå‡» index.html é¢„è§ˆã€‚")